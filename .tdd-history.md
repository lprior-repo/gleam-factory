# TDD-TCR-REFACTOR Session History

This file tracks the reasoning from each agent to provide context to subsequent agents.

---


## Iteration 0 - SESSION START

Requirements: Enhance ALL modules in the factory-gleam codebase with targeted improvements:

AUDIT MODULE (src/audit.gleam):
1. Add audit_trail(bead: Bead, action: String) -> String
   - Format: '[timestamp] action: bead_slug'
2. Add validate_audit_entry(entry: String) -> Result(Nil, String)

CLI MODULE (src/cli.gleam):
3. Add parse_args(args: List(String)) -> Result(Command, String)
   - Pure function (testable without argv)
4. Add short flags: -s=--slug, -p=--priority

CONFIG MODULE (src/config.gleam):
5. Add with_data_dir(config: Config, dir: String) -> Config
6. Add merge_configs(base: Config, override: Config) -> Config

DOMAIN MODULE (src/domain.gleam):
7. Add bead_age_days(bead: Bead) -> Int
8. Add is_stale(bead: Bead, max_days: Int) -> Bool

ERRORS MODULE (src/errors.gleam):
9. Add format_error_context(err: String, file: String, line: Int) -> String
10. Add chain_errors(errors: List(String)) -> String

INTEGRATION MODULE (src/integration.gleam):
11. Add retry_with_backoff(f: fn() -> Result(a, e), retries: Int) -> Result(a, e)

PERSISTENCE MODULE (src/persistence.gleam):
12. Add backup_bead(bead: Bead, backup_dir: String) -> Result(Nil, String)

PROCESS MODULE (src/process.gleam):
13. Add run_with_timeout(cmd: String, timeout_ms: Int) -> Result(String, String)
14. Add capture_stderr(cmd: String) -> Result(#(String, String), String)

REPO MODULE (src/repo.gleam):
15. Add get_remote_url() -> Result(String, String)
16. Add is_clean() -> Result(Bool, String)

STAGES MODULE (src/stages.gleam):
17. Add validate_stage_transition(from: Stage, to: Stage) -> Result(Nil, String)

TCR MODULE (src/tcr.gleam):
18. Add tcr_stats() -> #(Int, Int) - returns (commits, reverts)

UTILS MODULE (src/utils.gleam):
19. Add truncate_string(s: String, max_len: Int) -> String
20. Add pad_left(s: String, width: Int, char: String) -> String

VALIDATION MODULE (src/validation.gleam):
21. Add validate_slug_format(slug: String) -> Result(String, String)
   - Must start with letter, only alphanumeric/underscores, max 50 chars
22. Add validate_priority(p: String) -> Result(Priority, String)
   - Accept P1/P2/P3, p1/p2/p3, 1/2/3

WORKTREE MODULE (src/worktree.gleam):
23. Add list_worktrees() -> Result(List(String), String)
24. Add cleanup_stale_worktrees(max_age_days: Int) -> Result(Int, String)

These span ALL 15 source modules with 24 functions total.

---

## Iteration 1 - AUDITOR

Excellent! Let me provide a summary of what I've done:

## TEST 1 COMPLETE: validate_slug_format validation

I've written a comprehensive test suite for the `validate_slug_format` function that will be in the new `validation` module. This test covers:

### Test Cases Written:
1. **Valid cases:**
   - `feature_123` - starts with letter, alphanumeric + underscore
   - `task_1_a_b_c` - multiple underscores and numbers
   - `a` + 49 `b`s = 50 char slug - at max length boundary

2. **Invalid cases (error conditions):**
   - `123_feature` - starts with number (must start with letter)
   - `_feature` - starts with underscore (must start with letter)
   - `feature-name` - contains hyphen (only alphanumeric and underscore allowed)
   - `feature@name` - contains special character
   - `a` + 50 `b`s = 51 char slug - exceeds 50 char max
   - Empty string

### Why This Test Design:
- **Tests ONE behavior**: Pure validation of slug format constraints
- **Drives clean design**: Forces implementer to write a focused validation function with clear rules
- **Comprehensive edge cases**: Covers all constraint boundaries (start char, allowed chars, max length)
- **Independent tests**: Each test is self-contained with a single assertion
- **Descriptive names**: Each test name clearly describes what it validates
- **Currently FAILS** âœ“ - The validation module doesn't exist yet, so tests fail (red phase of TDD)

### Next Step:
The implementer will create `src/validation.gleam` with a `pub fn validate_slug_format(slug: String) -> Result(String, String)` function that validates these exact rules. The function should return `Ok(slug)` if valid, or `Error(reason)` if invalid.

---
