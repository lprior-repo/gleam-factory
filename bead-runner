#!/bin/bash
#
# Bead Runner: Automated TDD-TCR loop over beads
#
# Picks the next ready bead (no blockers, highest priority), runs tdd-tcr-loop
# on it, marks it done or failed, then moves to the next one.
#
# Usage: ./bead-runner [--max-beads N] [--priority P0|P1|P2]
#
# Run this overnight and wake up to implemented features!
#

set -eo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

# Configuration
MAX_BEADS=100
PRIORITY_FILTER=""
PAUSE_BETWEEN=5  # seconds between beads
LOG_DIR=".factory/bead-runs"

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --max-beads)
            MAX_BEADS="$2"
            shift 2
            ;;
        --priority)
            PRIORITY_FILTER="$2"
            shift 2
            ;;
        --pause)
            PAUSE_BETWEEN="$2"
            shift 2
            ;;
        -h|--help)
            echo "Usage: ./bead-runner [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --max-beads N    Maximum beads to process (default: 100)"
            echo "  --priority P     Filter by priority (P0, P1, P2)"
            echo "  --pause SEC      Seconds between beads (default: 5)"
            echo "  -h, --help       Show this help"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

# Ensure log directory exists
mkdir -p "$LOG_DIR"

# Statistics
BEADS_COMPLETED=0
BEADS_FAILED=0
BEADS_SKIPPED=0
START_TIME=$(date +%s)

log_phase() {
    echo ""
    echo -e "${BLUE}════════════════════════════════════════════════════════════${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}════════════════════════════════════════════════════════════${NC}"
    echo ""
}

log_info() {
    echo -e "${CYAN}→ $1${NC}"
}

log_success() {
    echo -e "${GREEN}✓ $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}⚠ $1${NC}"
}

log_error() {
    echo -e "${RED}✗ $1${NC}"
}

# Get next ready bead (no blockers, open or in-progress)
get_next_bead() {
    local priority_arg=""
    if [ -n "$PRIORITY_FILTER" ]; then
        priority_arg="--priority $PRIORITY_FILTER"
    fi

    # Get ready beads (no blockers), sorted by priority
    # bd ready returns beads that have no blocking dependencies
    bd ready --json $priority_arg 2>/dev/null | jq -r '.[0] | select(. != null)' 2>/dev/null
}

# Get bead details
get_bead_details() {
    local bead_id="$1"
    bd show "$bead_id" --json 2>/dev/null
}

# Mark bead as in-progress
claim_bead() {
    local bead_id="$1"
    bd update "$bead_id" --status in-progress 2>/dev/null
}

# Mark bead as done
complete_bead() {
    local bead_id="$1"
    local reason="$2"
    bd close "$bead_id" --reason "$reason" 2>/dev/null
}

# Mark bead as failed (but keep open for retry)
fail_bead() {
    local bead_id="$1"
    local reason="$2"
    # Add a comment about the failure, keep status as open for manual review
    bd comment "$bead_id" "BEAD-RUNNER FAILURE: $reason" 2>/dev/null || true
    bd update "$bead_id" --status open 2>/dev/null || true
}

# Create requirements file from bead
create_requirements_file() {
    local bead_id="$1"
    local bead_json="$2"
    local req_file="$LOG_DIR/${bead_id}-requirements.md"

    local title=$(echo "$bead_json" | jq -r '.title // "No title"')
    local description=$(echo "$bead_json" | jq -r '.description // "No description"')
    local acceptance=$(echo "$bead_json" | jq -r '.acceptance // "Tests pass"')

    cat > "$req_file" << EOF
# $title

## Description
$description

## Acceptance Criteria
$acceptance

## Context
- Bead ID: $bead_id
- This is an atomic task from the Factory-Synapse system implementation
- Follow Gleam idioms and functional programming best practices
- Use gleam_otp for actor model where specified
- All code must pass tests to be committed (TCR discipline)
EOF

    echo "$req_file"
}

# Run TDD-TCR loop on a bead
run_bead() {
    local bead_id="$1"
    local bead_json="$2"
    local title=$(echo "$bead_json" | jq -r '.title // "Unknown"')

    log_phase "PROCESSING BEAD: $bead_id"
    echo -e "${MAGENTA}Title: $title${NC}"

    # Create requirements file
    local req_file=$(create_requirements_file "$bead_id" "$bead_json")
    log_info "Requirements file: $req_file"

    # Log file for this run
    local log_file="$LOG_DIR/${bead_id}-$(date +%Y%m%d-%H%M%S).log"

    # Claim the bead
    log_info "Claiming bead..."
    claim_bead "$bead_id"

    # Run TDD-TCR loop
    log_info "Starting TDD-TCR loop..."
    if ./tdd-tcr-loop "$req_file" 2>&1 | tee "$log_file"; then
        # Success!
        log_success "Bead completed successfully!"
        complete_bead "$bead_id" "Completed by bead-runner via TDD-TCR loop"
        BEADS_COMPLETED=$((BEADS_COMPLETED + 1))
        return 0
    else
        # Failure
        log_error "TDD-TCR loop failed"
        local failure_reason=$(tail -20 "$log_file" | head -10)
        fail_bead "$bead_id" "TDD-TCR loop failed. See log: $log_file"
        BEADS_FAILED=$((BEADS_FAILED + 1))
        return 1
    fi
}

# Print final statistics
print_stats() {
    local end_time=$(date +%s)
    local duration=$((end_time - START_TIME))
    local hours=$((duration / 3600))
    local minutes=$(((duration % 3600) / 60))
    local seconds=$((duration % 60))

    echo ""
    echo -e "${GREEN}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}  BEAD RUNNER STATISTICS${NC}"
    echo -e "${GREEN}═══════════════════════════════════════════════════════════${NC}"
    echo -e "  Duration:    ${hours}h ${minutes}m ${seconds}s"
    echo -e "  Completed:   ${GREEN}$BEADS_COMPLETED${NC}"
    echo -e "  Failed:      ${RED}$BEADS_FAILED${NC}"
    echo -e "  Skipped:     ${YELLOW}$BEADS_SKIPPED${NC}"
    echo -e "  Total:       $((BEADS_COMPLETED + BEADS_FAILED + BEADS_SKIPPED))"
    echo -e "${GREEN}═══════════════════════════════════════════════════════════${NC}"
    echo ""

    # Show remaining ready beads
    local remaining=$(bd ready --json 2>/dev/null | jq 'length' 2>/dev/null || echo "?")
    echo -e "  Remaining ready beads: $remaining"
    echo ""
}

# Cleanup on exit
cleanup() {
    print_stats
    log_info "Bead runner stopped"
}

trap cleanup EXIT

# Main loop
main() {
    log_phase "BEAD RUNNER STARTING"
    echo "Max beads: $MAX_BEADS"
    echo "Priority filter: ${PRIORITY_FILTER:-all}"
    echo "Pause between: ${PAUSE_BETWEEN}s"
    echo "Log directory: $LOG_DIR"
    echo ""

    # Check dependencies
    command -v bd >/dev/null 2>&1 || { log_error "bd not found"; exit 1; }
    command -v jq >/dev/null 2>&1 || { log_error "jq not found"; exit 1; }
    [ -f "./tdd-tcr-loop" ] || { log_error "tdd-tcr-loop not found"; exit 1; }

    # Initial ready count
    local ready_count=$(bd ready --json 2>/dev/null | jq 'length' 2>/dev/null || echo "0")
    log_info "Ready beads available: $ready_count"

    local processed=0

    while [ $processed -lt $MAX_BEADS ]; do
        # Get next ready bead
        local bead_json=$(get_next_bead)

        if [ -z "$bead_json" ] || [ "$bead_json" = "null" ]; then
            log_info "No more ready beads available"
            break
        fi

        local bead_id=$(echo "$bead_json" | jq -r '.id')

        if [ -z "$bead_id" ] || [ "$bead_id" = "null" ]; then
            log_warning "Could not extract bead ID, skipping"
            BEADS_SKIPPED=$((BEADS_SKIPPED + 1))
            sleep 2
            continue
        fi

        # Get full bead details
        local full_bead=$(get_bead_details "$bead_id")

        # Run the bead
        if run_bead "$bead_id" "$full_bead"; then
            log_success "Bead $bead_id completed"
        else
            log_warning "Bead $bead_id failed, continuing to next"
        fi

        processed=$((processed + 1))

        # Pause between beads
        if [ $processed -lt $MAX_BEADS ]; then
            log_info "Pausing ${PAUSE_BETWEEN}s before next bead..."
            sleep $PAUSE_BETWEEN
        fi
    done

    log_phase "BEAD RUNNER COMPLETE"
    echo "Processed $processed beads"
}

main "$@"
